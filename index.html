<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>jocarsa | mecanografía — SPM</title>
<style>
  :root{
    --bg:#f7f9fc;
    --panel:#ffffff;
    --ink:#0e1b2b;
    --muted:#5a6b85;
    --accent:#2b6be6;
    --good:#1a9e61;
    --bad:#d13f3f;
    --warn:#c27b00;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif; background:radial-gradient(1200px 600px at 100% -100%,#e7eefb 0%, transparent 60%), var(--bg); color:var(--ink);
  }
  header{
    display:flex; gap:12px; align-items:center; padding:16px; position:sticky; top:0; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.75)); backdrop-filter: blur(6px); border-bottom:1px solid #d5e0fb;
  }
  header h1{font-size:18px; margin:0; letter-spacing:.5px; opacity:.95}
  header .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  select, button, input, textarea{
    background:#ffffff; color:var(--ink); border:1px solid #c9d6f5; border-radius:10px; padding:8px 10px; outline:none; box-shadow:0 0 0 0 rgba(43,107,230,0); transition:.2s border,.2s box-shadow;
  }
  select:focus, button:focus, input:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(43,107,230,.15)}
  button{cursor:pointer; font-weight:600}
  button.primary{background:linear-gradient(180deg,#6ea8ff,#4d8df1); color:white; border-color:#4d8df1}
  button.secondary{background:#f2f6ff}
  button:disabled{opacity:.5; cursor:not-allowed}

  main{max-width:1100px; margin:18px auto; padding:0 16px; display:grid; grid-template-columns: 1fr; gap:16px}
  .board{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px}
  @media (max-width: 900px){ .board{grid-template-columns:1fr} }

  .card{background:var(--panel); border:1px solid #d5e0fb; border-radius:16px; padding:16px; box-shadow:0 6px 16px rgba(0,0,0,.06)}
  .card h2{margin:0 0 12px; font-size:16px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}

  .exercise-area{min-height:190px; display:flex; flex-direction:column; gap:10px}
  .target, .typed{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:20px; line-height:1.6; padding:12px; border-radius:12px}
  .target{background:#f2f6ff; border:1px solid #d5e0fb}
  .typed{background:#f9fbff; border:1px dashed #d5e0fb; min-height:52px; white-space:pre-wrap}
  .meter{height:10px; border-radius:999px; background:#f0f3fb; border:1px solid #d5e0fb; overflow:hidden}
  .meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--good),#47b9ff); transition:width .2s ease}
  .legend{display:flex; gap:14px; flex-wrap:wrap; color:var(--muted); font-size:12px}
  .legend b{color:var(--ink)}
  .next-char{display:inline-block; min-width:1ch; padding:2px 4px; border-radius:6px; background:#eaf1ff; border:1px solid #c9d6f5}

  .keyboard{display:grid; gap:6px}
  .row{display:flex; gap:6px; justify-content:center}
  .key{user-select:none; text-transform:uppercase; font-weight:600; letter-spacing:.04em; font-size:14px; background:#ffffff; border:1px solid #c9d6f5; color:#203256; padding:14px 10px; border-radius:10px; min-width:40px; text-align:center; box-shadow: inset 0 -3px 0 rgba(0,0,0,.05); position:relative; transition: transform .05s ease, background .15s ease, border .15s ease}
  .key.wide{min-width:70px}
  .key.xwide{min-width:120px}
  .key.space{min-width:360px}
  .key.next{border-color:#5aa1ff; background:#eaf1ff; box-shadow:0 0 0 3px rgba(110,168,255,.15), inset 0 -3px 0 rgba(0,0,0,.05)}
  .key.hit{background:#e6f7ef; border-color:#8ad4b1}
  .key.miss{background:#ffeaea; border-color:#f1a6a6}

  .stats{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
  @media (max-width:700px){.stats{grid-template-columns: repeat(2,1fr)}}
  .stat{background:#ffffff; border:1px solid #d5e0fb; padding:12px; border-radius:12px; text-align:center}
  .stat .label{font-size:12px; color:var(--muted)}
  .stat .value{font-size:24px; font-weight:800; margin-top:6px}

  .footer-note{color:#48639b; font-size:12px}
  textarea{resize:vertical; min-height:70px; width:320px}

  /* Botón de informe */
  #downloadReport{display:none; margin-top:10px}
</style>
</head>
<body>
  <header>
    <h1>jocarsa | mecanografía — Golpes por minuto</h1>
    <div class="controls">
      <label>
        Lección
        <select id="lesson">
          <option value="home">Fila de inicio (ASDF JKLÑ)</option>
          <option value="top">Fila superior (QWERTY)</option>
          <option value="bottom">Fila inferior (ZXCVBNM)</option>
          <option value="punct">Números y puntuación</option>
          <option value="phrase">Frases cortas</option>
          <option value="custom">Texto personalizado…</option>
        </select>
      </label>
      <label>
        Personalizado
        <textarea id="customText" placeholder="Pega o escribe tu ejercicio aquí…" disabled></textarea>
      </label>
      <button id="start" class="primary">Comenzar</button>
      <button id="reset" class="secondary" disabled>Reiniciar</button>
    </div>
  </header>

  <main>
    <section class="board">
      <div class="card exercise-area">
        <h2>Ejercicio</h2>
        <div class="target" id="target"></div>
        <div class="typed" id="typed" aria-live="polite"></div>
        <div class="meter"><i id="progress"></i></div>
        <div class="legend">
          Siguiente tecla: <span id="nextChar" class="next-char">—</span>
          <span>Tiempo: <b id="time">0.0s</b></span>
          <span>Pulsaciones: <b id="keys">0</b></span>
          <span>GPM: <b id="spm">0</b></span>
          <span>Precisión: <b id="acc">100%</b></span>
        </div>
      </div>

      <div class="card">
        <h2>Teclado</h2>
        <div class="keyboard" id="keyboard"></div>
        <p class="footer-note">Pulsa la tecla resaltada. Se permite retroceso (Backspace). GPM = pulsaciones totales / minutos transcurridos.</p>
      </div>
    </section>

    <section class="card">
      <h2>Resultados</h2>
      <div class="stats">
        <div class="stat"><div class="label">Tiempo</div><div class="value" id="rTime">0.0s</div></div>
        <div class="stat"><div class="label">Pulsaciones</div><div class="value" id="rKeys">0</div></div>
        <div class="stat"><div class="label">GPM</div><div class="value" id="rSpm">0</div></div>
        <div class="stat"><div class="label">Precisión</div><div class="value" id="rAcc">100%</div></div>
      </div>
      <button id="downloadReport" class="secondary">Descargar informe Markdown</button>
    </section>
  </main>

  <script>
  // ----------------------------
  // Datos: lecciones y teclado ES
  // ----------------------------
  const LESSONS = {
    home: "a s d f j k l ñ a s d f j k l ñ asdf jklñ asdf jklñ asdf jklñ",
    top: "q w e r t y u i o p qwertyuiop qwerty uiop",
    bottom: "z x c v b n m , . zxcvbnm , . zxcvbnm",
    punct: "1 2 3 4 5 6 7 8 9 0 - = , . ; : ' \" ! ? ( )",
    phrase: "el veloz murcielago hindu comia feliz cardillo y kiwi"
  };

  const KEYBOARD_LAYOUT = [
    ["esc","1","2","3","4","5","6","7","8","9","0","'","¡","backspace"],
    ["tab","q","w","e","r","t","y","u","i","o","p","`","+","\\"],
    ["caps","a","s","d","f","g","h","j","k","l","ñ",";","enter"],
    ["shift","<","z","x","c","v","b","n","m",",",".","-","shift"],
    ["ctrl","alt","space","alt","ctrl"]
  ];

  function normKey(k){
    if(k === " ") return "space";
    if(k === "Backspace") return "backspace";
    if(k === "Shift") return "shift";
    if(k === "Control") return "ctrl";
    if(k === "Alt") return "alt";
    if(k === "CapsLock") return "caps";
    if(k === "Enter") return "enter";
    if(k === "Tab") return "tab";
    return k.toLowerCase();
  }

  // ----------------------------
  // Construcción del teclado
  // ----------------------------
  const kb = document.getElementById('keyboard');
  const keyEls = new Map();
  function buildKeyboard(){
    kb.innerHTML = '';
    for(const row of KEYBOARD_LAYOUT){
      const r = document.createElement('div');
      r.className = 'row';
      row.forEach(label =>{
        const el = document.createElement('div');
        el.className = 'key';
        el.dataset.key = label;
        el.textContent = label;
        if(["backspace","enter","shift","caps","tab"].includes(label)) el.classList.add('wide');
        if(label === 'space') el.classList.add('space','xwide');
        r.appendChild(el);
        keyEls.set(label, el);
      });
      kb.appendChild(r);
    }
  }

  function flashKey(label, cls){
    const el = keyEls.get(label);
    if(!el) return;
    el.classList.add(cls);
    clearTimeout(el._t); el._t = setTimeout(()=> el.classList.remove(cls), 120);
  }

  // ----------------------------
  // Motor de ejercicio
  // ----------------------------
  const els = {
    lesson: document.getElementById('lesson'),
    custom: document.getElementById('customText'),
    start: document.getElementById('start'),
    reset: document.getElementById('reset'),
    target: document.getElementById('target'),
    typed: document.getElementById('typed'),
    progress: document.getElementById('progress'),
    nextChar: document.getElementById('nextChar'),
    time: document.getElementById('time'),
    keys: document.getElementById('keys'),
    spm: document.getElementById('spm'),
    acc: document.getElementById('acc'),
    rTime: document.getElementById('rTime'),
    rKeys: document.getElementById('rKeys'),
    rSpm: document.getElementById('rSpm'),
    rAcc: document.getElementById('rAcc'),
    dlBtn: document.getElementById('downloadReport')
  };

  let state = {
    userName: 'Invitado',
    text: '',
    typed: '',
    startedAt: null,   // se fija en la primera pulsación
    endedAt: null,
    timerId: null,
    totalKeys: 0,
    correctKeys: 0,
    done: false
  };

  function setLessonUI(){
    const v = els.lesson.value;
    const custom = (v === 'custom');
    els.custom.disabled = !custom;
    els.custom.style.opacity = custom ? 1 : .5;
  }

  function pickText(){
    const v = els.lesson.value;
    if(v === 'custom'){
      const t = els.custom.value.trim();
      return t.length? t : 'Escribe tu texto personalizado arriba y pulsa Comenzar.';
    }
    return LESSONS[v];
  }

  function reset(){
    state = {userName: state.userName || 'Invitado', text:'',typed:'',startedAt:null,endedAt:null,timerId:null,totalKeys:0,correctKeys:0,done:false};
    els.typed.textContent='';
    els.progress.style.width='0%';
    els.time.textContent='0.0s';
    els.keys.textContent='0';
    els.spm.textContent='0';
    els.acc.textContent='100%';
    els.rTime.textContent='0.0s';
    els.rKeys.textContent='0';
    els.rSpm.textContent='0';
    els.rAcc.textContent='100%';
    els.dlBtn.style.display='none';
    keyEls.forEach(el=> el.classList.remove('next'));
    updateNextChar('—');
    els.reset.disabled = true;
  }

  function renderTarget(){
    const idx = state.typed.length;
    const before = state.text.slice(0, idx);
    const after = state.text.slice(idx);
    els.target.innerHTML = `<span style="color:var(--muted)">${escapeHtml(before)}</span><span style="opacity:.9">${escapeHtml(after)}</span>`;
    const next = state.text[idx] ?? '✔';
    updateNextChar(next);
  }

  function updateNextChar(ch){
    els.nextChar.textContent = ch === ' ' ? '␣' : ch;
    keyEls.forEach(el=> el.classList.remove('next'));
    const expectedKey = normKey(ch || '');
    if(expectedKey && keyEls.get(expectedKey)){
      keyEls.get(expectedKey).classList.add('next');
    }
  }

  function start(){
    reset();
    // Pide nombre (se recuerda en localStorage)
    const prev = localStorage.getItem('jocar_meca_name') || '';
    const name = prompt('¿Cómo te llamas?', prev || '') || '';
    state.userName = name.trim() || 'Invitado';
    localStorage.setItem('jocar_meca_name', state.userName);

    state.text = pickText();
    els.target.textContent = state.text;
    renderTarget();
    els.start.disabled = true;
    els.reset.disabled = false;
    // Arranca el HUD (sin tiempo hasta primera tecla)
    state.timerId = setInterval(updateHud, 120);
    window.addEventListener('keydown', onKey);
  }

  function finish(){
    if(state.done) return;
    state.done = true;
    state.endedAt = performance.now();
    clearInterval(state.timerId); state.timerId=null;
    window.removeEventListener('keydown', onKey);
    updateHud(true);
    els.start.disabled = false;
    // Informe Markdown: descarga automática + botón visible
    const md = buildMarkdownReport();
    triggerDownload(md, fileNameForReport());
    els.dlBtn.style.display='inline-block';
    els.dlBtn.onclick = ()=> triggerDownload(md, fileNameForReport());
  }

  function onKey(e){
    if(state.done) return;
    const k = e.key;
    const nk = normKey(k);

    // Ignora modificadores
    if(["shift","ctrl","alt","caps","tab"].includes(nk)) return;

    // Primer arranque de cronómetro: primera tecla válida
    if(state.startedAt === null){
      state.startedAt = performance.now();
    }

    state.totalKeys++;

    // Visual: tecla pulsada
    flashKey(nk,'hit');

    if(nk === 'backspace'){
      if(state.typed.length>0){
        state.typed = state.typed.slice(0,-1);
        redrawTyped();
      }
      updateHud();
      e.preventDefault();
      return;
    }

    const expected = state.text[state.typed.length] || '';
    const ch = k.length === 1 ? k : (k === 'Enter' ? '\n' : '');

    if(!ch) { updateHud(); return; }

    if(ch === expected){
      state.correctKeys++;
      state.typed += ch;
      redrawTyped(true);
    } else {
      flashKey(nk,'miss');
      state.typed += ch; // permite ver error y corregir con retroceso
      redrawTyped(false);
    }

    const done = state.typed.length >= state.text.length;
    if(done) finish();
    updateHud();
  }

  function redrawTyped(){
    const idx = state.typed.length;
    const pieces = [];
    for(let i=0;i<idx;i++){
      const good = state.text[i] === state.typed[i];
      const ch = escapeHtml(state.typed[i] || '');
      pieces.push(`<span style="border-bottom:2px solid ${good? 'var(--good)':'var(--bad)'}">${ch || '&nbsp;'}</span>`);
    }
    els.typed.innerHTML = pieces.join('');
    renderTarget();
    els.progress.style.width = Math.min(100, (idx/state.text.length)*100) + '%';
  }

  function getElapsedSeconds(){
    if(state.startedAt === null) return 0;
    const end = state.done && state.endedAt ? state.endedAt : performance.now();
    return Math.max(0, (end - state.startedAt) / 1000);
  }

  function updateHud(finalize=false){
    const elapsedSec = getElapsedSeconds();
    const minutes = Math.max(elapsedSec/60, 1e-9);
    const spm = Math.round(state.totalKeys / minutes);
    const acc = state.totalKeys? Math.round((state.correctKeys/state.totalKeys)*100) : 100;

    // HUD en vivo
    els.time.textContent = elapsedSec.toFixed(1) + 's';
    els.keys.textContent = state.totalKeys;
    els.spm.textContent = state.startedAt === null ? '0' : spm; // 0 hasta empezar
    els.acc.textContent = acc + '%';

    // Resultados (en vivo y final)
    els.rTime.textContent = elapsedSec.toFixed(1)+'s';
    els.rKeys.textContent = state.totalKeys;
    els.rSpm.textContent = state.startedAt === null ? '0' : spm;
    els.rAcc.textContent = acc + '%';
  }

  function escapeHtml(s){
    return (s+'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
  }

  // ----------------------------
  // Informe Markdown
  // ----------------------------
  function buildMarkdownReport(){
    const elapsedSec = getElapsedSeconds();
    const minutes = Math.max(elapsedSec/60, 1e-9);
    const spm = state.startedAt === null ? 0 : Math.round(state.totalKeys / minutes);
    const acc = state.totalKeys? Math.round((state.correctKeys/state.totalKeys)*100) : 100;
    const when = new Date().toISOString();

    return `# Informe de mecanografía — jocarsa | mecanografía

- **Alumno**: ${state.userName}
- **Fecha**: ${when}
- **Lección**: ${document.getElementById('lesson').selectedOptions[0].text}
- **Tiempo**: ${elapsedSec.toFixed(1)} s
- **Pulsaciones (totales)**: ${state.totalKeys}
- **GPM (golpes por minuto)**: ${spm}
- **Precisión**: ${acc}%

## Texto del ejercicio
\`\`\`
${state.text}
\`\`\`

## Texto tecleado
*(✔ correcto, ✖ error por posición)*  
> Nota: El sistema permite retroceso; los errores corregidos ya no penalizan precisión.
`;
  }

  function fileNameForReport(){
    const safeName = (state.userName || 'invitado').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    return `mecanografia_${safeName}_${ts}.md`;
  }

  function triggerDownload(content, filename){
    const blob = new Blob([content], {type:'text/markdown'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  }

  // ----------------------------
  // Enlazar UI
  // ----------------------------
  buildKeyboard();
  setLessonUI();
  reset();

  els.lesson.addEventListener('change', ()=>{ setLessonUI(); });
  els.start.addEventListener('click', start);
  els.reset.addEventListener('click', ()=>{
    finish(); // asegura cierre si estaba en curso
    reset();
    els.start.disabled=false;
    els.target.textContent=pickText();
    renderTarget();
  });

  // Mostrar texto inicial
  els.target.textContent = pickText();
  renderTarget();

  // Evitar scroll con barra espaciadora durante el ejercicio
  window.addEventListener('keydown', (e)=>{ if(e.key === ' ' && !state.done) e.preventDefault(); }, {passive:false});
  </script>
</body>
</html>

